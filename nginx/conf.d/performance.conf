# Performance optimizations for RevEd Kids
# This file is included by the main nginx.conf

# Enable efficient file serving
sendfile on;
sendfile_max_chunk 1m;
tcp_nopush on;
tcp_nodelay on;

# Optimize buffer sizes for better performance
fastcgi_buffers 16 16k;
fastcgi_buffer_size 32k;
proxy_buffers 8 16k;
proxy_buffer_size 32k;

# Enable connection pooling
upstream_keepalive_connections 32;
upstream_keepalive_requests 100;
upstream_keepalive_timeout 60s;

# Cache static content in browser
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header Vary "Accept-Encoding";
    
    # Enable CORS for fonts
    if ($request_filename ~* ^.*?\.(eot|woff|woff2|ttf)$) {
        add_header Access-Control-Allow-Origin "*";
    }
}

# Cache HTML files for shorter time
location ~* \.(html|htm)$ {
    expires 1h;
    add_header Cache-Control "public, must-revalidate";
}

# Don't cache dynamic content
location ~* \.(json|xml)$ {
    expires -1;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
}